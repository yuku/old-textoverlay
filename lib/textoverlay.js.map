{"version":3,"sources":["../src/textoverlay.js"],"names":["css","wrapper","overflow","overlay","color","position","width","textarea","background","outline","height","margin","properties","Textoverlay","strategies","parentElement","Error","textareaStyle","window","getComputedStyle","createWrapper","createOverlay","textareaStyleWas","Object","keys","forEach","key","style","getPropertyValue","setStyle","handleInput","bind","handleScroll","handleResize","addEventListener","observer","MutationObserver","observe","attributes","attributeFilter","wrapperDisplay","display","render","document","createElement","className","insertBefore","appendChild","copyTextareaStyle","removeEventListener","disconnect","remove","skipUpdate","update","sync","firstChild","removeChild","computeOverlayNodes","node","top","scrollTop","boundingRect","getBoundingClientRect","reduce","ns","strategy","highlight","Array","prototype","concat","apply","map","nodeType","Node","TEXT_NODE","text","textContent","resp","prevIndex","match","lastIndex","exec","push","createTextNode","slice","str","length","span","cloneNode","value","target","setProperty","element"],"mappings":"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","file":"textoverlay.js","sourcesContent":["/**\n * textoverlay.js - Simple decorator for textarea elements\n *\n * @author Yuku Takahashi <taka84u9@gmail.com>\n * @flow\n */\n\nconst css = {\n  wrapper: {\n    \"box-sizing\": \"border-box\",\n    overflow: \"hidden\",\n  },\n  overlay: {\n    \"box-sizing\": \"border-box\",\n    \"border-color\": \"transparent\",\n    \"border-style\": \"solid\",\n    color: \"transparent\",\n    position: \"absolute\",\n    \"white-space\": \"pre-wrap\",\n    \"word-wrap\": \"break-word\",\n    overflow: \"hidden\",\n    width: \"100%\",\n  },\n  textarea: {\n    background: \"transparent\",\n    \"box-sizing\": \"border-box\",\n    outline: \"none\",\n    position: \"relative\",\n    height: \"100%\",\n    width: \"100%\",\n    margin: \"0px\",\n  },\n};\n\n// Firefox does not provide shorthand properties in getComputedStyle, so we use the expanded ones here.\nconst properties = {\n  wrapper: [\n    \"background-attachment\",\n    \"background-blend-mode\",\n    \"background-clip\",\n    \"background-color\",\n    \"background-image\",\n    \"background-origin\",\n    \"background-position\",\n    \"background-position-x\",\n    \"background-position-y\",\n    \"background-repeat\",\n    \"background-size\",\n    \"display\",\n    \"margin-top\",\n    \"margin-right\",\n    \"margin-bottom\",\n    \"margin-left\",\n  ],\n  overlay: [\n    \"font-family\",\n    \"font-size\",\n    \"font-weight\",\n    \"line-height\",\n    \"padding-top\",\n    \"padding-right\",\n    \"padding-bottom\",\n    \"padding-left\",\n    \"border-top-width\",\n    \"border-right-width\",\n    \"border-bottom-width\",\n    \"border-left-width\",\n  ],\n};\n\nexport type Strategy = {\n  match: RegExp;\n  css: { [string]: string };\n};\n\nexport default class Textoverlay {\n  strategies: Strategy[];\n  observer: MutationObserver;\n  wrapperDisplay: string;\n\n  overlay: HTMLDivElement;\n  textarea: HTMLTextAreaElement;\n  textareaStyle: CSSStyleDeclaration;\n  textareaStyleWas: { [string]: string };\n  wrapper: HTMLDivElement;\n\n  handleInput: () => void;\n  handleResize: () => void;\n  handleScroll: () => void;\n\n  constructor(textarea: HTMLTextAreaElement, strategies: Strategy[]) {\n    if (!textarea.parentElement) {\n      throw new Error(\"textarea must be in the DOM tree\");\n    }\n    this.textarea = textarea;\n    this.textareaStyle = window.getComputedStyle(textarea);\n    this.createWrapper();\n    this.createOverlay();\n\n    this.textareaStyleWas = {};\n    Object.keys(css.textarea).forEach(key => {\n      this.textareaStyleWas[key] = this.textarea.style.getPropertyValue(key);\n    });\n    setStyle(this.textarea, css.textarea);\n\n    this.strategies = strategies;\n\n    this.handleInput = this.handleInput.bind(this);\n    this.handleScroll = this.handleScroll.bind(this);\n    this.handleResize = this.handleResize.bind(this);\n    this.textarea.addEventListener(\"input\", this.handleInput);\n    this.textarea.addEventListener(\"scroll\", this.handleScroll);\n    this.observer = new MutationObserver(this.handleResize);\n    this.observer.observe(this.textarea, {\n      attributes: true,\n      attributeFilter: [\"style\"],\n    });\n\n    this.wrapperDisplay = this.wrapper.style.display;\n    this.render();\n  }\n\n  /**\n   * @protected\n   */\n  createWrapper() {\n    this.wrapper = document.createElement(\"div\");\n    this.wrapper.className = \"textoverlay-wrapper\";\n    setStyle(this.wrapper, css.wrapper);\n    this.wrapper.style.position =\n        this.textareaStyle.position === \"static\" ? \"relative\" : this.textareaStyle.position;\n    const parentElement: Element = (this.textarea.parentElement: any);\n    parentElement.insertBefore(this.wrapper, this.textarea);\n    this.wrapper.appendChild(this.textarea);\n  }\n\n  /**\n   * @protected\n   */\n  createOverlay() {\n    this.overlay = document.createElement(\"div\");\n    this.overlay.className = \"textoverlay\";\n    setStyle(this.overlay, css.overlay);\n    this.copyTextareaStyle(this.overlay, properties.overlay);\n    this.wrapper.insertBefore(this.overlay, this.textarea);\n  }\n\n  destroy() {\n    this.textarea.removeEventListener(\"input\", this.handleInput);\n    this.textarea.removeEventListener(\"scroll\", this.handleScroll);\n    this.observer.disconnect();\n    this.overlay.remove();\n    setStyle(this.textarea, this.textareaStyleWas);\n    const parentElement = this.wrapper.parentElement;\n    if (parentElement) {\n      parentElement.insertBefore(this.textarea, this.wrapper);\n      this.wrapper.remove();\n    }\n  }\n\n  /**\n   * Public API to update and sync textoverlay\n   */\n  render(skipUpdate: boolean = false) {\n    if (!skipUpdate) {\n      this.update();\n    }\n    this.sync();\n  }\n\n  /**\n   * Update contents of textoverlay\n   *\n   * @private\n   */\n  update() {\n    // Remove all child nodes from overlay.\n    while (this.overlay.firstChild) {\n      this.overlay.removeChild(this.overlay.firstChild);\n    }\n\n    this.computeOverlayNodes().forEach(node => this.overlay.appendChild(node));\n  }\n\n  /**\n   * Sync scroll and size of textarea\n   *\n   * @private\n   */\n  sync() {\n    this.overlay.style.top = `${-this.textarea.scrollTop}px`;\n    // In IE11, dimensions returned by `getComputedStyle` do not take `box-sizing` into account.\n    // We use `getBoundingClientRect` instead as a workaround.\n    const boundingRect = this.wrapper.getBoundingClientRect();\n    this.wrapper.style.height = `${boundingRect.height}px`;\n    if (this.wrapperDisplay !== \"block\") {\n        this.wrapper.style.width = `${boundingRect.width}px`;\n    }\n  }\n\n  /**\n   * @private\n   */\n  computeOverlayNodes(): Node[] {\n    return this.strategies.reduce((ns: Node[], strategy) => {\n      const highlight = document.createElement(\"span\");\n      setStyle(highlight, strategy.css);\n      return Array.prototype.concat.apply([], ns.map(node => {\n        if (node.nodeType != Node.TEXT_NODE) { return node; }\n        const text = node.textContent;\n        const resp = [];\n        while (true) {\n          const prevIndex = strategy.match.lastIndex;\n          const match = strategy.match.exec(text);\n          if (!match) {\n            resp.push(document.createTextNode(text.slice(prevIndex)));\n            break;\n          }\n          const str = match[0];\n          resp.push(document.createTextNode(text.slice(prevIndex, strategy.match.lastIndex - str.length)));\n          const span = highlight.cloneNode();\n          span.textContent = str;\n          resp.push(span);\n        }\n        return resp;\n      }));\n    }, [document.createTextNode(this.textarea.value)]);\n  }\n\n  handleInput() {\n    this.render();\n  }\n\n  handleScroll() {\n    this.render(true);\n  }\n\n  handleResize() {\n    this.render(true);\n  }\n\n  /**\n   * @private\n   */\n  copyTextareaStyle(target: HTMLElement, keys: string[]) {\n    keys.forEach(key => {\n      target.style.setProperty(key, this.textareaStyle.getPropertyValue(key));\n    });\n  }\n}\n\n/**\n * Set style to the element.\n */\nfunction setStyle(element: HTMLElement, style: { [string]: string }) {\n  Object.keys(style).forEach(key => {\n    element.style.setProperty(key, style[key]);\n  });\n}\n"]}